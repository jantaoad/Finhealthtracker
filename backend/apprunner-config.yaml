# App Runner Service Configuration - Backend
# Reference: https://docs.aws.amazon.com/apprunner/latest/dg/service-create.html

version: 1.0

# Service Name
serviceName: finhealthtracker-backend

# Source Configuration (Docker Image)
source:
  image:
    imageIdentifier: YOUR_AWS_ACCOUNT_ID.dkr.ecr.us-east-1.amazonaws.com/finhealthtracker-backend:latest
    imageRepositoryType: ECR

# Instance Configuration (Production)
instanceConfig:
  cpu: 1        # 0.25, 0.5, 1, 2
  memory: 2     # 1, 2, 3, 4 (GB)

# Port Configuration
portConfiguration:
  port: 5000
  protocol: HTTP

# Environment Variables (अपने values से replace करें)
environmentVariables:
  - name: NODE_ENV
    value: production
  - name: PORT
    value: "5000"
  - name: JWT_SECRET
    value: your-super-secret-jwt-key-change-this
  - name: JWT_EXPIRY
    value: 24h
  
  # Database Configuration
  - name: DB_HOST
    value: your-postgres-host.aws.com
  - name: DB_PORT
    value: "5432"
  - name: DB_NAME
    value: finhealthtracker_prod
  - name: DB_USER
    value: postgres
  # DB_PASSWORD को Secrets Manager में store करें!
  
  # AI Service Integration
  - name: AI_SERVICE_URL
    value: https://finhealthtracker-ai-service-hash.awsapprunner.com
  - name: AI_API_KEY
    value: your-api-key-here
  
  # Frontend URL (CORS)
  - name: CORS_ORIGIN
    value: https://finhealthtracker-frontend-hash.awsapprunner.com

# Auto Scaling (Production)
autoScaling:
  maxConcurrency: 200
  maxSize: 10  # Maximum instances
  minSize: 2   # Minimum instances (high availability)

# Health Check Configuration
healthCheck:
  protocol: HTTP
  path: /health
  interval: 30
  timeout: 5
  healthyThreshold: 1
  unhealthyThreshold: 3

# Network Configuration
network:
  ingressConfiguration:
    isPubliclyAccessible: true
  egressConfiguration:
    egressType: DEFAULT
    # Optional VPC configuration for database access

# IAM Role & Secrets Manager
iamRole: finhealthtracker-apprunner-role

# Database Migration (Optional)
observability:
  traceConfiguration:
    enabled: false

# Tags
tags:
  - key: Project
    value: FinHealthTracker
  - key: Environment
    value: Production
  - key: Service
    value: Backend
  - key: Component
    value: API

# Advanced Settings
advancedSettings:
  # Enable logs
  logsConfiguration:
    enabled: true
  # Security
  preferPublicAddress: false
